# 데이터 관리 및 볼륨 작업
## docker data 종류
## 애플레케이션 데이터 (code + environment)
* 개발자가 설정하고 작성한 코드 패키지
* 이 코드와 환경이 빌드 단계에서 이미지에 추가됨(Dockerfile 사용)
* 컨테이너 실행시 컨테이너는 제공된 환경에서 코드 사용함.
* 이미지가 복사되면 코드와 이와 관련된 모든 것들은 고정됨(이미지 변경 불가:read-only)
* 변경 발생시 새이미지를 빌드해야 함.

## 애플리케이션이 실행되는 동안 생성된 데이터
* ex) 사용자 요청 폼 데이터, 변수에 저장되는 임시데이터
* 메모리에만 저장되는 일시적인 데이터(컨테이너 종료시 사라지는 데이터)
* 컨테이너가 실행되는 동안 컨테이너에 저장되는 일시적인 read+write 를 하는 데이터.
* 컨테이너에 저장된다는 것은 컨테이너를 구성하는 부가(extra)레이어를 이용함
* 부가레이어 로직 : 이미지 인식, 이미지 파일시스템 인식하고 복사하지않고 미러링하는 로직
* 도커는 실제로 read-write 액세스 권한을 가짐 = 파일의 시스템을 조작 가능
* 이미지에서 변경하지 않고 부가레이어에서 변경함.
* 도커는 컨테이너의 변경사항을 추적하고 이미지의 파일시스템을 가져와 최종 파일시스템을 파생시켜 read-write 레이어에 저장된 변경사항과 결합시킴
* 컨테이너에 데이터를 저장하라고 하면 컨테이너는 이 정보를 저장하며 파일이 무엇이든 간에 이 read-write 레이어에 저장하거나 그 read-write 레이어의 도움을 받아 저장함

## 영구 애플리케이션 데이터
* DB, 파일에 저장되어야 하는 데이터
* 실행중인 컨테이너에서 그 데이터를 가져와 생성
* = 컨테이너에서 실행중인 애플리케이션 내의 데이터는 저장되어야 함
* 컨테이너가 중지, 다시시작, 제거 되더라도 데이터는 생존해야함
* 영구 앱데이터는 read+write 데이터임
* = 이러한 데이터를 컨테이너에 저장하지만 볼륨을 이용해야함

---

## 볼륨(Volume)이란?
* 호스트 머신의 폴더(컨테이너나 이미지에 존재 하지 않음)
* 호스트 컴퓨터의 드라이브에 존재하여 사용가능하거나 도커 컨테이너 내부 폴더에 매핑되는 것을 의미
* = 컨테이너 내부의 폴더를 호스트 컴퓨터 상의 컨테이너 외부 폴더에 연결 가능
* 두 폴더의 변경사항을 다른 폴더에 반영
* 컨테이너가 종료된 경우에도 지속되며 계속 존재함
* 컨테이너에 볼륨을 추가하는 경우 해당 볼륨은 제거되지 않으며 컨테이너가 제거되어도 해당 볼륨이 유지되어 볼륨의 데이터 또한 유지됨
* 컨테이너는 볼륨에 데이터를 읽고 쓰기 가능

## 도커의 외부 저장 메커니즘

### 볼륨
관리 주체 : 도커
#### 익명 볼륨(Anonymous Volumes)
* 컨테이너가 존재하는 동안에만 실제로 존재(컨테이너 제거시 사라짐)
* = 하나의 특정 컨테이너에만 연결
  ### Dockerfile
      ~~~
      VOLUME ["컨테이너의 외부 폴더에 매핑되어질 컨테이너 내부 위치"]
      ex) VOLUME ["/app/backend"]
      ~~~
#### 명명된 볼륨(Named Volumes)
* 컨테이너가 종료된 후에도 볼륨이 유지됨
* = 새컨테이너를 실행하여도 해당 폴더에 저장된 모든 데이터를 계속 사용 가능함
* 영구적으로 저장되야 하거나 편집하거나 직접 read 할 필요가 없는 중요한 데이터에 적합(편집 불가능)
* 도커 파일 내부에 명명된 볼륨 생성 불가
* 컨테이너 실행시 명명된 볼륨을 생성해야함
* 컨테이너가 종료(제거)되어도 도커에 의해 삭제되지 않음
* 하나의 컨테이너에만 연결되진 않음

#### 명령어
    docker run -v [명명된 볼륨명:/컨테이너 파일 시스템 내부 경로] 

#### 공통
두 경우 모두 일부 폴더와 경로를 호스트 머신에 설정

docker volume
ls 현재 관리 중인 모든 볼륨 리스팅


### 바인드 마운트(Bind Mounts)
* 관리주체 : 개발자
* 호스트 머신 상에 매핑될 컨테이너 경로를 설정함
* 컨테이너는 볼륨에서 read-write 가 가능하기에 소스코드 또한 바인트 마운트에 넣을 수 있음
* = 소스코드 변경시 매번 이미지를 빌드 하는 것이 아닌 바인트 마운트를 통한 상시 변경을 이루어냄(=항상 최신의 코드 액세스 가능)
* 컨테이너는 바인드 마운트를 인식하여 소스코드를 스냅샷에서 복사하는 것이 아닌 바인드 마운트에서 복사
* 스냅샷 뿐만 아닌 처음에 이미지를 생성할때에 그 이미지에도 추가함
* 영구적이고 편집 가능한 데이터에 적합
* 이미지에 영향을 주지 않고 컨테이너에만 영향을 줌
* 바인트 마운트와 폴더를 컨테이너에 마운트 할 경우 참고 사항
  * 바인트 마운트로 공유 중인 폴더에 도커가 액세스 가능한지 확인해야함 <br/>
    (도커 Preferences 에 엑세스 -> 실행중인 도커 서비스 -> Resources-File sharing 하단 <br/>
    -> 공유폴더가 리스팅 되는지 확인 )
  *
#### 명령어
    -v docker run ["호스트머신 상 프로젝트 폴더 절대 경로(or 파일경로):/컨테이너 파일 시스템 내부 경로(제어하려는 경로)"]
    #경로상에 공백 또는 이와 유사한 것들이 있을 경우 전체 매핑경로를 큰따옴표로 묶음


### 볼륨 - 바인드 마운트 공통
* 컨테이너에 정의된 경로는 생성된 어떤 볼륨에 매핑됨.
* = 호스트 머신 상의 생성된 경로로 연결됨
* 도커에 의해 관리되기에 호스트 머신 어딘가에 저장되어 있으나 해당 폴더를 액세스하여 작업해선 안됨
---